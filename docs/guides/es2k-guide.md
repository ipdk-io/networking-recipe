# ES2K Setup Guide for P4 Control Plane

## Overview

This document explains how to install, build, and run P4 Control Plane
for the ES2K target.

## Setup

### Install basic utilities

```bash
For Fedora distro: yum install libatomic libnl3-devel openssl-devel
For Ubuntu distro: apt install libatomic1 libnl-route-3-dev libssl-dev
pip3 install -r requirements.txt
```

### Install P4 SDE

Obtain a copy of the SDE for the Intel IPU E2100 and install it on your
development system. A common install location is '/opt/p4/p4sde`.

### Build and install infrap4d dependencies

```bash
git clone --recursive https://github.com/ipdk-io/networking-recipe.git ipdk.recipe
cd ipdk.recipe
export IPDK_RECIPE=`pwd`
cd $IPDK_RECIPE/setup
cmake -B build -DCMAKE_INSTALL_PREFIX=<dependency install path> [-DUSE_SUDO=ON]
cmake --build build [-j<njobs>]
```

*Note*: If running as non-root user, provide `-DUSE_SUDO=ON` option to cmake
config.

### Build P4 Control Plane

#### Set environment variables

- export DEPEND_INSTALL=`absolute path for installing dependencies`
- export SDE_INSTALL=`absolute path for p4 sde install built in previous step`

```bash
source ./scripts/es2k/setup_env.sh $IPDK_RECIPE $SDE_INSTALL $DEPEND_INSTALL 
```

#### Compile the recipe

```bash
cd $IPDK_RECIPE
./make-all.sh --target=es2k
```

*Note*: By default, `make-all.sh` will create an `install` directory under the
networking recipe. User can specify a different directory using `--prefix`
option to make-all.sh. The following examples assume default `install`
directory for the executables. If not, user will need to specify the
appropriate path instead of ./install.

### Run Infrap4d

#### Set up the environment required by infrap4d

*Note*: `sudo` option is required when running copy_config_files.sh since
we are creating directories and copying config file at system level.

```bash
sudo ./scripts/es2k/copy_config_files.sh $IPDK_RECIPE $SDE_INSTALL
```

#### Set hugepages required for ES2K

Run the hugepages script.

```bash
sudo ./scripts/es2k/set_hugepages.sh
```

#### Export all environment variables to sudo user

```bash
alias sudo='sudo PATH="$PATH" HOME="$HOME" LD_LIBRARY_PATH="$LD_LIBRARY_PATH" SDE_INSTALL="$SDE_INSTALL"'
```

#### Run the infrap4d daemon

```bash
cd $IPDK_RECIPE
sudo ./install/sbin/infrap4d
```

*Note*: By default, infrap4d runs in detached mode. If you want to run in
attached mode, specify the --nodetach command-line option.

- All infrap4d logs are by default logged under `/var/log/stratum`.
- All P4SDE logs are logged in `p4_driver.log` under `$IPDK_RECIPE`.
*-All OVS logs are logged under `/tmp/ovs-vswitchd.log`.

### Run a sample program

Open a new terminal to set the pipeline and try the sample P4 program.
Set up the environment and export all environment variables to sudo user.

```bash
source ./scripts/setup_env.sh $IPDK_RECIPE $SDE_INSTALL $DEPEND_INSTALL
./scripts/copy_config_files.sh $IPDK_RECIPE $SDE_INSTALL
alias sudo='sudo PATH="$PATH" HOME="$HOME" LD_LIBRARY_PATH="$LD_LIBRARY_PATH" SDE_INSTALL="$SDE_INSTALL"'
```

#### Create IPDF netdevs

After installing ATE Kernel on HOST machine, install the following drivers
to bind the network devices (netdevs) to the E2100 target.

```bash
modprobe idpf
modprobe auxiliary
modprobe iecm
modprobe iavf
```

#### Create P4 artifacts

- P4 programs are available in the P4 SDE repository.

- Obtain a copy of the P4 Compiler for ES2K and install it on your
  development system.

- Set the environment variable OUTPUT_DIR to the location where artifacts
  should be generated and where p4 files are available

```bash
export OUTPUT_DIR=/root/p4-driver/mev_reference_p4_files/simple_l3_l4_pna
```

- Generate the artifacts using the p4c compiler installed in the previous step:

```bash
p4c-pna-xxp -I/usr/lib -I/usr/share/p4c/p4include -I/usr/share/p4c/idpf-lib \
            $OUTPUT_DIR/simple_l3_l4_pna.p4 -o $OUTPUT_DIR/simple_l3_l4_pna.s \
            --p4runtime-files $OUTPUT_DIR/simple_l3_l4_pna.p4info.txt \
            --context $OUTPUT_DIR/simple_l3_l4_pna.context.json \
            --bfrt $OUTPUT_DIR/simple_l3_l4_pna.bfrt.json
```

*Note*: The above commands will generate three files
(`simple_l3_l4_pna.p4info.txt`, `simple_l3_l4_pna.bfrt.json`, and
`simple_l3_l4_pna.context.json`).

- Modify `simple_l3_l4_pna.conf` to specify the correct paths for
  bfrt-config, context, and config.

- Create a dummy tofino.bin file, which is needed by tdi_pipeline_builder.

```bask
touch tofino.bin
```

- TDI pipeline builder combines the artifacts generated by the p4c compiler
  to generate a single bin file to be pushed from the controller.
  Generate binary executable using the TDI pipeline builder command below:

```bash
./install/bin/tdi_pipeline_builder \
    --p4c_conf_file=$OUTPUT_DIR/simple_l3_l4_pna.conf \
    --bf_pipeline_config_binary_file=$OUTPUT_DIR/simple_l3_l4_pna.pb.bin
```

#### Set forwarding pipeline

```bash
sudo ./install/bin/p4rt-ctl set-pipe br0 $OUTPUT_DIR/simple_l3_l4_pna.pb.bin $OUTPUT_DIR/simple_l3_l4_pna.p4info.txt
```

#### Configure forwarding rule to receive traffic

Add a forwarding rule to receive traffic on VSI-1 (base offset 16 + VSI ID 1) \
when the key matches.

```bash
sudo  ./install/bin/p4rt-ctl add-entry br0 MainControlImpl.l3_l4_match_rx \
    "hdrs.ipv4[vmeta.common.depth].protocol=0x11,vmeta.common.port_id=0,istd.direction=0,
    hdrs.ipv4[vmeta.common.depth].src_ip="192.168.1.10",hdrs.ipv4[vmeta.common.depth].dst_ip="192.168.1.20",
    hdrs.udp[vmeta.common.depth].sport=1000,hdrs.udp[vmeta.common.depth].dport=2000,action=MainControlImpl.send(17)"
```

 *Note*: See [p4rt-ctl Readme](../clients/p4rt-ctl.rst) for more information
 on the `p4rt-ctl` utility.

#### Test traffic from link partner to E2100

Send a packet from a physical port of link partner to the E2100 using any
traffic generator application, and listen on the netdev corresponding to VSI-1
using `tcpdump`.

```text
sendp(Ether(dst="6e:80:97:ae:1e:4e", src="00:00:00:09:03:14")/IP(src="192.168.1.10", dst="192.168.1.20")/UDP(sport=1000, dport=2000)/Raw(load="0"*50), iface='ens78f0')
```
